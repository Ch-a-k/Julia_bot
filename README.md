## Telegram Paywall Bot (MonoPay)

– Когда пользователь пишет /start, бот приветствует его и показывает главное меню с тремя кнопками: «Оформить подписку», «Информация» и «Проверить доступ». Даже если пользователь просто пишет любое сообщение, бот снова покажет меню.
– Кнопка «Информация» рассказывает, что это за канал.
– Кнопка «Проверить доступ» помогает понять, есть ли у пользователя активная подписка и находится ли он в канале. Если доступ есть, бот подтверждает это и ещё раз отправляет информационный блок. Если доступа нет — предложит оформить подписку.
– Кнопка «Оформить подписку» открывает список тарифов: на 1 месяц или на 3 месяца. Если бот работает в обычном режиме, он создаёт счёт через MonoPay и отправляет ссылку для оплаты. А в тестовом режиме (TEST_MODE=1) сразу выдаёт ссылку-приглашение в канал — без оплаты. Если персональную ссылку не удаётся создать, используется общая (для того, чтобы пользователь не ждал и не писал в поддержку)
– Интеграция с MonoPay полностью автоматизирована: бот создаёт счёт с нужной суммой, принимает вебхук /monopay/webhook, проверяет подпись (если это не тест), обновляет статус платежа и при успешной оплате сразу продлевает или создаёт подписку в базе данных. После этого пользователь получает одноразовую или временную ссылку на канал.
– Все доступы к каналу выдаются автоматически. Если что-то пошло не так и персональная ссылка не сгенерировалась, бот использует резервную — общую ссылку канала.
– Подписки и платежи хранятся в SQLite. Если пользователь продлевает подписку, новый срок просто добавляется к оставшемуся времени.
– Каждые час бот проверяет, у кого закончились подписки. Таких пользователей он удаляет из канала (корректно, через бан и разбан) и, если возможно(если человек еще подписан на бот), пишет им, что доступ закрыт. Ежедневно в 10:00 бот напоминает всем пользователям без подписки, что можно её оформить — но не чаще одного раза в день.
– Команда /pay всегда доступна и мгновенно показывает кнопки для оформления подписки.

Для корректной работы бот должен быть администратором канала с правами на приглашение участников по ссылкам и возможность исключать их.


Features:
- Показывает тарифы (1 мес, 3 мес)
- Создаёт счёт в MonoPay и обрабатывает вебхук
- Выдаёт уникальную ссылку на канал после оплаты
- Автоматически удаляет пользователя по окончании подписки

### Настройка
1) Создайте бота в Telegram через @BotFather и получите токен
2) Создайте приватный канал, добавьте бота как администратора с правами приглашения/бана
3) Получите токен MonoPay (X-Token) и, при необходимости, секрет вебхука
4) Создайте файл `.env` по аналогии:

```
TELEGRAM_BOT_TOKEN=...
TELEGRAM_CHANNEL_ID=-100XXXXXXXXXX
MONOPAY_TOKEN=...
MONOPAY_WEBHOOK_SECRET=...
PUBLIC_BASE_URL=https://your-domain.com
PORT=3000
DATABASE_PATH=./data/bot.db
CCY=980
TEST_MODE=1
```

### Запуск

```
npm run dev
```

Для продакшена:
```
npm run build && npm start
```

Настройте в кабинете MonoPay URL вебхука: `https://your-domain.com/monopay/webhook`

### Локальный запуск через Docker

1) Создайте `.env` в корне проекта (см. пример выше)
2) Запустите в дев-режиме с лайв-обновлениями:
```
docker compose up --build
```
Приложение будет доступно на `http://localhost:3000`. Вебхук MonoPay локально можно тестировать через `ngrok` или `cloudflared`, пробрасывая `PUBLIC_BASE_URL`.

Для продакшен-образа:
```
docker build -t julia-bot:prod --target prod .
docker run --env-file .env -p 3000:3000 -v $(pwd)/data:/app/data julia-bot:prod
```

### Тестирование без оплаты
- Установите в `.env`: `TEST_MODE=1`
- Запустите бота и нажмите тариф. Бот сразу выдаст одноразовую ссылку на канал без оплаты.
- Сигнатура вебхука в тестовом режиме не проверяется.


# Julia_bot
